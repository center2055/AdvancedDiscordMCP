name: Discord Release Notification

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to use (defaults to latest)'
        required: false
        type: string

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Get release information
        id: release_info
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ -n "${{ github.event.inputs.release_tag }}" ]; then
              RELEASE_TAG="${{ github.event.inputs.release_tag }}"
            else
              RELEASE_TAG=$(gh release list --limit 1 --json tagName -q '.[0].tagName')
            fi
            RELEASE_DATA=$(gh release view "$RELEASE_TAG" --json tagName,name,body,url,publishedAt,author)
          else
            RELEASE_TAG="${{ github.event.release.tag_name }}"
            RELEASE_DATA=$(gh release view "$RELEASE_TAG" --json tagName,name,body,url,publishedAt,author)
          fi
          
          echo "tag_name=$(echo "$RELEASE_DATA" | jq -r '.tagName')" >> $GITHUB_OUTPUT
          echo "name=$(echo "$RELEASE_DATA" | jq -r '.name')" >> $GITHUB_OUTPUT
          echo "body=$(echo "$RELEASE_DATA" | jq -r '.body // ""')" >> $GITHUB_OUTPUT
          echo "url=$(echo "$RELEASE_DATA" | jq -r '.url')" >> $GITHUB_OUTPUT
          echo "published_at=$(echo "$RELEASE_DATA" | jq -r '.publishedAt')" >> $GITHUB_OUTPUT
          echo "author=$(echo "$RELEASE_DATA" | jq -r '.author.login')" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Send to Discord
        run: |
          WEBHOOK_URL="${{ secrets.DISCORD_WEBHOOK_URL }}"
          
          if [ -z "$WEBHOOK_URL" ]; then
            echo "Error: DISCORD_WEBHOOK_URL secret is not set"
            exit 1
          fi
          
          # Build the embed payload using jq for proper JSON escaping
          EMBED_PAYLOAD=$(jq -n \
            --arg title "${{ steps.release_info.outputs.name }}" \
            --arg description "${{ steps.release_info.outputs.body }}" \
            --arg url "${{ steps.release_info.outputs.url }}" \
            --arg timestamp "${{ steps.release_info.outputs.published_at }}" \
            --arg author "${{ steps.release_info.outputs.author }}" \
            --arg tag "${{ steps.release_info.outputs.tag_name }}" \
            '{
              "embeds": [{
                "title": $title,
                "description": $description,
                "url": $url,
                "color": 3447003,
                "timestamp": $timestamp,
                "footer": {
                  "text": "GitHub Release"
                },
                "author": {
                  "name": ("Released by " + $author)
                },
                "fields": [
                  {
                    "name": "Tag",
                    "value": $tag,
                    "inline": true
                  }
                ]
              }]
            }')
          
          curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$EMBED_PAYLOAD"

