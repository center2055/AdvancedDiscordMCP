name: Discord Release Notification

on:
  release:
    types: [published]

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Send release notification to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          RELEASE_NAME="${{ github.event.release.name }}"
          CHANGELOG="${{ github.event.release.body }}"
          REPO_NAME="${{ github.repository }}"
          RELEASE_URL="${{ github.event.release.html_url }}"
          AUTHOR="${{ github.event.release.author.login }}"
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          # Truncate changelog if too long (Discord embed limit is 2000 chars)
          if [ ${#CHANGELOG} -gt 2000 ]; then
            CHANGELOG="${CHANGELOG:0:1997}..."
          fi
          
          # Escape JSON special characters
          CHANGELOG_ESCAPED=$(echo "$CHANGELOG" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
          RELEASE_NAME_ESCAPED=$(echo "$RELEASE_NAME" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g')
          
          # Create and send JSON payload using jq for proper JSON handling
          curl -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"ðŸš€ New Release: $RELEASE_NAME_ESCAPED\",
                \"description\": \"$CHANGELOG_ESCAPED\",
                \"url\": \"$RELEASE_URL\",
                \"color\": 5865,
                \"fields\": [
                  {
                    \"name\": \"Version\",
                    \"value\": \"$VERSION\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"Repository\",
                    \"value\": \"[$REPO_NAME](https://github.com/$REPO_NAME)\",
                    \"inline\": true
                  }
                ],
                \"author\": {
                  \"name\": \"$AUTHOR\",
                  \"url\": \"https://github.com/$AUTHOR\",
                  \"icon_url\": \"https://github.com/$AUTHOR.png\"
                },
                \"footer\": {
                  \"text\": \"GitHub Release\",
                  \"icon_url\": \"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png\"
                },
                \"timestamp\": \"$TIMESTAMP\"
              }]
            }"


