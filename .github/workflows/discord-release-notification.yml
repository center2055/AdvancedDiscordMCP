name: Discord Release Notification

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup GitHub CLI and jq
        run: |
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh jq -y
      
      - name: Send release notification to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          GH_TOKEN: ${{ github.token }}
        run: |
          # Handle both release event and manual trigger
          if [ -n "${{ github.event.release.tag_name }}" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            RELEASE_NAME="${{ github.event.release.name }}"
            CHANGELOG="${{ github.event.release.body }}"
            RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/${{ github.event.release.tag_name }}"
            AUTHOR="${{ github.event.release.author.login }}"
          else
            # Fallback for manual trigger - use latest release
            LATEST_RELEASE=$(gh release view --repo ${{ github.repository }} --json tagName,name,body,author)
            VERSION=$(echo "$LATEST_RELEASE" | jq -r '.tagName')
            RELEASE_NAME=$(echo "$LATEST_RELEASE" | jq -r '.name')
            CHANGELOG=$(echo "$LATEST_RELEASE" | jq -r '.body')
            RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/$VERSION"
            AUTHOR=$(echo "$LATEST_RELEASE" | jq -r '.author.login')
          fi
          REPO_NAME="${{ github.repository }}"
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          # Truncate changelog if too long (Discord embed limit is 2000 chars)
          if [ ${#CHANGELOG} -gt 2000 ]; then
            CHANGELOG="${CHANGELOG:0:1997}..."
          fi
          
          # Use jq to properly construct JSON payload
          jq -n \
            --arg title "ðŸš€ New Release: $RELEASE_NAME" \
            --arg description "$CHANGELOG" \
            --arg url "$RELEASE_URL" \
            --arg version "$VERSION" \
            --arg repo "$REPO_NAME" \
            --arg author "$AUTHOR" \
            --arg timestamp "$TIMESTAMP" \
            '{
              embeds: [{
                title: $title,
                description: $description,
                url: $url,
                color: 5865,
                fields: [
                  {
                    name: "Version",
                    value: $version,
                    inline: true
                  },
                  {
                    name: "Repository",
                    value: "[\($repo)](https://github.com/\($repo))",
                    inline: true
                  }
                ],
                author: {
                  name: $author,
                  url: "https://github.com/\($author)",
                  icon_url: "https://github.com/\($author).png"
                },
                footer: {
                  text: "GitHub Release",
                  icon_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
                },
                timestamp: $timestamp
              }]
            }' | curl -X POST "$DISCORD_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d @-


